--// tuff shit
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TextChatService = game:GetService("TextChatService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

--// CONFIG
local DARKTRIAD_IMAGE = "rbxassetid://124494375618781"
local MEOWL_IMAGE = "rbxassetid://17700937473"
local activeMode = nil -- "dark" or "meowl"
local connections = {}
local charAddedConn

--// FUNCTION: Add image to head
local function addHeadImage(character, imageId, tagName, spin)
    local head = character:WaitForChild("Head")
    
    -- Remove old Billboard if exists
    if head:FindFirstChild(tagName) then
        head[tagName]:Destroy()
    end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = tagName
    billboard.Adornee = head
    billboard.Size = UDim2.new(2, 0, 2, 0)
    billboard.StudsOffset = Vector3.new(0, 0, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = head

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,1,0)
    frame.BackgroundTransparency = 1
    frame.AnchorPoint = Vector2.new(0.5,0.5)
    frame.Position = UDim2.new(0.5,0.5,0.5,0)
    frame.Parent = billboard

    local img = Instance.new("ImageLabel")
    img.Size = UDim2.new(1,0,1,0)
    img.Position = UDim2.new(0.5,0.5,0.5,0)
    img.AnchorPoint = Vector2.new(0.5,0.5)
    img.BackgroundTransparency = 1
    img.Image = imageId
    img.Parent = frame

    local angle = 0
    local conn
    conn = RunService.RenderStepped:Connect(function(dt)
        if activeMode ~= tagName:lower() or not head.Parent then
            conn:Disconnect()
            return
        end

        -- Only spin if requested
        if spin then
            angle = angle + dt * 180
            img.Rotation = angle % 360
        end

        -- Fade based on distance
        local dist = (camera.CFrame.Position - head.Position).Magnitude
        local fadeStart, fadeEnd = 2, 0.5
        img.ImageTransparency = math.clamp((fadeStart - dist)/(fadeStart - fadeEnd),0,1)
    end)

    table.insert(connections, conn)
end

--// Disable all head images
local function disableAll()
    activeMode = nil
    local head = player.Character:FindFirstChild("Head")
    if head then
        if head:FindFirstChild("darktriadbillboard") then head.darktriadbillboard:Destroy() end
        if head:FindFirstChild("meowlbillboard") then head.meowlbillboard:Destroy() end
    end
    for _, conn in pairs(connections) do if conn then conn:Disconnect() end end
    connections = {}
end

--// Toggle functions
local function toggleDarkTriad()
    if activeMode == "darktriad" then
        disableAll()
    else
        disableAll()
        activeMode = "darktriad"
        addHeadImage(player.Character, DARKTRIAD_IMAGE, "darktriad", true)
        charAddedConn = player.CharacterAdded:Connect(function(char)
            if activeMode == "darktriad" then
                addHeadImage(char, DARKTRIAD_IMAGE, "darktriad", true)
            end
        end)
    end
end

local function toggleMeowl()
    if activeMode == "meowl" then
        disableAll()
    else
        disableAll()
        activeMode = "meowl"
        addHeadImage(player.Character, MEOWL_IMAGE, "MeowlBillboard", false)
        charAddedConn = player.CharacterAdded:Connect(function(char)
            if activeMode == "meowl" then
                addHeadImage(char, MEOWL_IMAGE, "MeowlBillboard", false)
            end
        end)
    end
end

--// CHAT COMMANDS
TextChatService.OnIncomingMessage = function(message)
    local content = message.Text:lower()
    if content == ".darktriad" then
        toggleDarkTriad()
    elseif content == ".meowl" then
        toggleMeowl()
    end
end
